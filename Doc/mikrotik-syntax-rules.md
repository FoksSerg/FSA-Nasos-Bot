# Правила синтаксиса MikroTik RouterOS v7+

## ⚠️ КРИТИЧЕСКИ ВАЖНОЕ ПРАВИЛО

### 1. ПОДТВЕРЖДЕНИЕ ДЕЙСТВИЙ
- НИКОГДА не выполнять действия без явного подтверждения пользователя
- ВСЕГДА спрашивать разрешение перед:
  - Удалением файлов
  - Изменением конфигурации
  - Перезаписью существующих файлов
  - Любыми системными операциями
- Дождаться явного "ДА" от пользователя перед выполнением

## ЗАПРЕЩЕННЫЕ КОНСТРУКЦИИ

### 1. `:return` - РАБОТАЕТ ТОЛЬКО В ФУНКЦИЯХ
- `:return` можно использовать только внутри функций (`:global myFunc do={...}`)
- `:return` НЕ РАБОТАЕТ в обычном скрипте для выхода
- Для выхода из скрипта используйте `:error` или правильную логику if/else

### 2. `:tostr` - ПРАВИЛА ИСПОЛЬЗОВАНИЯ
- `:tostr` работает корректно и рекомендуется для явного преобразования в строку
- Доступные функции преобразования: `:toarray`, `:tobool`, `:toid`, `:toip`, `:toip6`, `:tonum`, `:tostr`, `:totime`

### 3. `:put` и `:error` В СКРИПТАХ
- `:put` - в скриптах использовать `:log info/warning/error` для записи в логи (`:put` работает только в консоли)
- `:error` - ЗАПРЕЩЕНА в скриптах, вызывает критическую ошибку и останавливает выполнение

### 4. `/import` - КОМАНДА НЕ СУЩЕСТВУЕТ
- Использовать `/system script run <script-name>` вместо `/import`

## СИНТАКСИЧЕСКИЕ ПРАВИЛА

### 1. ПЕРЕМЕННЫЕ
- Обязательно объявлять перед использованием: `:local myVar` или `:global myVar`
- Имена переменных: только буквы и цифры
- Для спецсимволов в именах используйте кавычки: `:global "my-var"`
- Регистрозависимые: `myVar` ≠ `myVAr`
- Очистка переменных после использования: `:set var ""`

### 2. СТРОКИ И КОНКАТЕНАЦИЯ
- Интерполяция переменных `"текст $переменная"` может не работать
- Используйте конкатенацию: `("текст " . $переменная . " текст")`
- Длинные строки (>120 символов) разбивайте на части
- Экранирование специальных символов: `\"`, `\\`, `\n`, `\r`, `\t`, `\$`, `\_`

### 3. МАТЕМАТИЧЕСКИЕ ОПЕРАЦИИ
- Избегайте сложных выражений в одной строке
- `($hours * 3600 + $minutes * 60 + $seconds)` → разбить на 3 операции
- Используйте скобки для группировки: `(10 / 2)` вместо `10/2`

### 4. ПРОБЕЛЫ В КОМАНДАХ И ТОЧКИ С ЗАПЯТОЙ
Пробелы НЕ ДОПУСКАЮТСЯ между:
- `<parameter>=` → правильно: `gateway=192.168.1.1`
- `from=` `to=` `step=` `in=` `do=` `else=`

**Точки с запятой `;`:**
- НЕ ОБЯЗАТЕЛЬНЫ в конце строк
- НУЖНЫ только между командами на одной строке
- Пример: `:local a 1; :local b 2; :put ($a + $b)`

### 5. РАБОТА С МАССИВАМИ
- Индексация начинается с 0
- Объявление: `:toarray` или `{1;2;3}`
- Разделитель элементов `;`
- Доступ к элементам через `:pick`
- Поиск через `:find`
- Конкатенация через `,`

### 6. РАБОТА С JSON
- Все JSON-строки должны быть валидированы перед использованием.
- Для преобразования данных в JSON используйте только функцию `:tojson`.
- Для разбора JSON используйте только функцию `:fromjson` и обязательно проверяйте результат на ошибки.
- При ошибке парсинга JSON — логировать ошибку и завершать выполнение соответствующего блока кода.

### 7. РАБОТА С API
- Все HTTP-запросы должны формироваться с помощью `/tool fetch` с явным указанием метода и заголовков.
- Ответ API всегда проверять на наличие ошибок (например, по коду ответа или содержимому).
- Токены и ключи доступа хранить только в глобальных переменных, не выводить в лог и не передавать в сторонние функции.
- При ошибке сети или недоступности API — делать не более 3 попыток с задержкой, после чего логировать ошибку и завершать выполнение блока.

### 8. ОПТИМИЗАЦИЯ
- Результаты DNS-запросов кэшировать в локальных переменных и использовать повторно в течение одной сессии скрипта.
- Перед созданием таймера с определённым именем — удалять существующий таймер с тем же именем.
- Для каждого таймера использовать уникальное имя, отражающее его назначение.
- Не использовать таймеры для долгосрочных задач (более 24 часов).
- После завершения задачи — удалять таймер.
- После завершения работы скрипта очищать все временные переменные через `:set var ""`.
- Все важные действия и ошибки логировать через `:log` с соответствующим уровнем (info, warning, error).

### 9. РАБОТА С SCHEDULER
- `[:parse $variable]` превращает строку в код, но scheduler ожидает строку
- Для scheduler передавать переменную напрямую: `on-event=$variable`
- НЕ использовать: `on-event=[:parse $variable]`

## ДОСТУПНЫЕ ФУНКЦИИ

### 1. Преобразование типов
- `:toarray` - в массив
- `:tobool` - в булево
- `:toid` - в internal ID  
- `:toip` - в IP адрес
- `:toip6` - в IPv6 адрес
- `:tonum` - в число (integer)
- `:tostr` - в строку
- `:totime` - во время
- `:tojson` - в JSON
- `:fromjson` - из JSON

### 2. Работа со строками/массивами
- `:len` - длина строки/массива
- `:pick` - извлечение подстроки/элемента
- `:find` - поиск в строке/массиве

### 3. Системные
- `:put` - вывод в консоль
- `:log` - запись в лог (debug, error, info, warning)
- `:delay` - пауза
- `:resolve` - DNS резолв
- `:typeof` - тип переменной
- `:time` - текущее время
- `:timestamp` - Unix timestamp

### 4. Управление переменными
- `:global <var> [<value>]` - глобальная переменная
- `:local <var> [<value>]` - локальная переменная  
- `:set <var> [<value>]` - установка значения
- `:set <var>` - удаление переменной (без значения)

## ОПЕРАТОРЫ

### 1. Арифметические
- `+` `-` `*` `/` `%` (остаток)
- Для деления используйте скобки: `(10)/2` или `10 / 2`

### 2. Логические
- `&&` или `and`
- `||` или `or`
- `!` (НЕ)

### 3. Сравнения
- `=` `!=` `<` `>` `<=` `>=`
- `~` (соответствие regex)

### 4. Конкатенация
- `.` - строки: `"hello" . " " . "world"`
- `,` - массивы: `{1;2;3} , 5`

## УПРАВЛЯЮЩИЕ СТРУКТУРЫ

### 1. Условия
```
:if (<условие>) do={
    <команды>
} else={
    <команды>
}
```

### 2. Циклы
```
:for <var> from=<start> to=<end> step=<step> do={
    <команды>
}

:foreach <var> in=<array> do={
    <команды>
}

:while (<условие>) do={
    <команды>
}
```

## ТИПЫ ДАННЫХ
- `num` - 64-битное целое число
- `bool` - true/false
- `str` - строка
- `ip` - IP адрес
- `ip-prefix` - IP сеть
- `ip6` - IPv6 адрес  
- `ip6-prefix` - IPv6 сеть
- `id` - внутренний ID (с префиксом *)
- `time` - время/дата
- `array` - массив
- `nil` - пустое значение

## ПРОВЕРКА ПЕРЕД ЗАПУСКОМ
1. Нет `:return` вне функций
2. Все переменные объявлены
3. Интерполяции заменены на конкатенацию
4. Сложная математика разбита
5. Длинные строки разделены
6. Правильные пробелы в командах
7. Проверка типов данных
8. Обработка ошибок API
9. Логирование критических операций 

## ПРАВИЛА ДЛЯ ИИ
- В начале каждого сообщения ИИ обязан писать: 
  "Текущая дата \"***\". С правилами ознакомлен и обязуюсь их соблюдать безоговорочно, за исключением явных указаний с вашей стороны!" 
- **АВТОМАТИЧЕСКИЙ ЗАПРОС ДАТЫ**: Не чаще чем раз в час самостоятельно запрашивать системную дату пользователя командой `date` и использовать актуальную дату в коде. Не полагаться на предыдущие данные о времени.
- При необходимости вставки текущей даты/времени всегда получать их непосредственно из системы пользователя командой `date`, а не использовать предположения или старые значения. 

## ПРАВИЛА ПРОЕКТА NASOSRUNNER

### СИНХРОНИЗАЦИЯ INIT ФАЙЛОВ
- `Nasos-Init.rsc.template` - шаблон для Git (без конфиденциальных данных)
- `Nasos-Init.rsc` - рабочий файл для MikroTik (с реальными токенами)
- При изменении логики - ОБЯЗАТЕЛЬНО синхронизировать ОБА файла
- Исключения синхронизации: только конфиденциальные переменные (BotToken, ChatId)
- MikroTik загружает код из `Nasos-Init.rsc` (рабочий файл)
- При редактировании template файла - ВСЕГДА проверить необходимость обновления рабочего файла 