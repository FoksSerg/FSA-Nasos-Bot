# История обсуждения интеграции Telegram в проект MikroTik

## Исходная задача
Пользователь работает с проектом MikroTik-скриптов (RouterOS 7.19.1) и хочет реализовать надёжную отправку сообщений в Telegram через fetch, чтобы сбои Telegram не прерывали основной скрипт. Требования: мультиплатформенность, строгий контроль ошибок, финальное сообщение в любом случае, соответствие линтерам и правилам.

## Анализ fetch
- Были протестированы все варианты fetch (output=user, as-value, output=file, keep-result, on-error и др.)
- Выяснено, что любые ошибки fetch (HTTP 4xx/5xx, DNS) приводят к аварийному завершению скрипта, даже если результат не анализируется
- Использование on-error, вложенных do, функций, циклов не помогает — RouterOS всё равно завершает job при ошибке fetch
- В продуктиве fetch работает только без output, но тогда нельзя программно анализировать результат

## Попытки изоляции fetch
- Вынесение fetch в отдельный скрипт, запуск через `/system script run` — не решает проблему: при ошибке дочерний скрипт может "заразить" основной, особенно при запуске из Winbox
- Использование глобальных переменных для передачи статуса/ошибки между скриптами — не всегда помогает, если дочерний скрипт аварийно завершился до их установки

## Ключевое решение — использование scheduler
- Предложено и реализовано: запускать отправку Telegram через отдельную задачу scheduler, созданную с ближайшим временем старта (текущее время + 1 секунда)
- После создания задачи основной скрипт делает паузу, анализирует глобальные переменные, удаляет задачу scheduler и всегда доходит до финального сообщения
- Такой подход полностью изолирует основной процесс от ошибок fetch, гарантирует завершение основного скрипта и позволяет безопасно отправлять любое количество сообщений

## Технические детали реализации
- Для каждой отправки вычисляется время старта задачи scheduler
- Используются глобальные переменные для передачи текста сообщения и статуса отправки
- После паузы (3 сек) основной скрипт логирует результат и удаляет задачу scheduler
- Пример кода и best practice оформлены для дальнейшего использования

## Вывод
- Найден уникальный и надёжный паттерн для отправки HTTP/Telegram из скриптов MikroTik без риска аварийного завершения основного процесса
- Пользователь доволен результатом и просит оформить best practice для дальнейшего распространения среди "хороших людей"

## Итог
Вся логика отправки Telegram вынесена в задачи scheduler, что обеспечивает полную изоляцию и надёжность работы скриптов MikroTik даже при ошибках fetch.

## Следующие шаги
1. Переименование тестовых скриптов:
   - `Send-Telegram` → `Telegram-Sender`
   - `Test-fetch` → `Telegram-Test`

2. Создание базового модуля для интеграции:
   - Создать файл `Telegram-Core.rsc` с базовыми функциями:
     - Инициализация (токен, chat_id)
     - Функция отправки
     - Функция получения времени
     - Обработка ошибок

3. Интеграция в существующие модули:
   - Добавить импорт `Telegram-Core.rsc` в каждый модуль
   - Заменить прямые вызовы fetch на вызовы через scheduler
   - Добавить обработку статусов отправки

4. Обновление документации:
   - Добавить описание нового механизма в README
   - Обновить комментарии в коде 